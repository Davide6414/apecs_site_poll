<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <title>Suggerimenti</title>
  <style>
    :root{
      --bg:#f0f7ff;
      --card:#ffffff;
      --text:#0a4d8f;
      --muted:#5c9fd6;
      --primary:#1e88e5;
      --primary-hover:#1565c0;
      --secondary:#e3f2fd;
      --border:#90caf9;
      --shadow: 0 1px 3px rgba(30,136,229,.15), 0 1px 2px rgba(30,136,229,.1);
      --shadow-lg: 0 10px 15px -3px rgba(30,136,229,.2), 0 4px 6px -2px rgba(30,136,229,.15);
      --radius:16px;
      --orange:#ff9800;
      --orange-light:#fff3e0;
    }
    
    @media (prefers-color-scheme: dark){
      :root{
        --bg:#0d1b2a;
        --card:#1b2838;
        --text:#e3f2fd;
        --muted:#90caf9;
        --primary:#42a5f5;
        --primary-hover:#1e88e5;
        --secondary:#1b3a52;
        --border:#2563a0;
        --shadow: 0 4px 6px -1px rgba(0,0,0,.5), 0 2px 4px -1px rgba(0,0,0,.3);
        --shadow-lg: 0 20px 25px -5px rgba(0,0,0,.6), 0 10px 10px -5px rgba(0,0,0,.4);
      }
    }
    
    *{
      box-sizing:border-box;
      -webkit-tap-highlight-color:transparent;
    }
    
    html,body{
      height:100%;
      margin:0;
      padding:0;
    }
    
    body{
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      color:var(--text);
      background:var(--bg);
      line-height:1.6;
      overflow-x:hidden;
    }

    /* Snowflakes Canvas */
    #snowCanvas{
      position:fixed;
      top:0;
      left:0;
      width:100%;
      height:100%;
      pointer-events:none;
      z-index:1;
    }

    /* Loading Overlay */
    #loadingOverlay{
      position:fixed;
      top:0;
      left:0;
      width:100%;
      height:100%;
      background:rgba(0,0,0,.6);
      backdrop-filter:blur(8px);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:9999;
      opacity:0;
      pointer-events:none;
      transition:opacity .3s ease;
    }
    
    #loadingOverlay.show{
      opacity:1;
      pointer-events:all;
    }
    
    .loader{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:16px;
    }
    
    .spinner{
      width:48px;
      height:48px;
      border:4px solid rgba(255,255,255,.2);
      border-top-color:#fff;
      border-radius:50%;
      animation:spin 1s linear infinite;
    }
    
    @keyframes spin{
      to{transform:rotate(360deg)}
    }
    
    .loader-text{
      color:#fff;
      font-size:16px;
      font-weight:500;
    }

    /* Main Container */
    .container{
      position:relative;
      z-index:2;
      max-width:900px;
      margin:0 auto;
      padding:60px 16px 80px;
    }
    
    @media (min-width:768px){
      .container{
        padding:80px 32px 100px;
      }
    }

    /* Panel Cards */
    .panel{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      margin-bottom:32px;
      overflow:hidden;
      transition:box-shadow .3s ease;
    }
    
    .panel:hover{
      box-shadow:var(--shadow-lg);
    }

    /* Section Header */
    .section-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:16px;
      padding:20px 24px;
      border-bottom:1px solid var(--border);
    }
    
    .section-head h2{
      margin:0;
      font-size:24px;
      font-weight:700;
      color:var(--text);
    }

    /* Controls */
    .controls{
      display:flex;
      gap:8px;
    }
    
    .ctrl-btn{
      min-width:44px;
      min-height:44px;
      border:1px solid var(--border);
      background:var(--card);
      color:var(--text);
      border-radius:12px;
      cursor:pointer;
      font-size:18px;
      display:flex;
      align-items:center;
      justify-content:center;
      transition:all .2s ease;
      box-shadow:var(--shadow);
    }
    
    .ctrl-btn:hover:not(:disabled){
      background:var(--secondary);
      transform:translateY(-2px);
      box-shadow:var(--shadow-lg);
    }
    
    .ctrl-btn:active:not(:disabled){
      transform:translateY(0);
    }
    
    .ctrl-btn:disabled{
      opacity:.3;
      cursor:not-allowed;
    }
    
    .ctrl-btn:focus-visible{
      outline:3px solid var(--primary);
      outline-offset:2px;
    }

    /* Carousel */
    .carousel{
      position:relative;
      overflow:hidden;
      min-height:300px;
    }
    
    .track{
      display:flex;
      flex-direction:column;
      transition:transform .5s cubic-bezier(.4,0,.2,1);
    }

    /* Card */
    .card{
      padding:24px;
      border-bottom:1px solid var(--border);
      min-height:200px;
    }
    
    .card:last-child{
      border-bottom:0;
    }
    
    .card h3{
      margin:0 0 12px;
      font-size:22px;
      font-weight:700;
      color:var(--text);
    }
    
    .meta{
      display:flex;
      align-items:center;
      gap:12px;
      margin-bottom:16px;
      flex-wrap:wrap;
    }
    
    .pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:8px 14px;
      border-radius:999px;
      background:var(--secondary);
      border:1px solid var(--border);
      font-size:15px;
      font-weight:600;
      color:var(--primary);
    }
    
    .like-btn{
      min-height:44px;
      padding:10px 20px;
      border:0;
      background:linear-gradient(135deg, var(--orange), #f57c00);
      color:#fff;
      border-radius:12px;
      font-weight:700;
      font-size:15px;
      cursor:pointer;
      transition:all .2s ease;
      box-shadow:0 4px 12px rgba(255,152,0,.35);
    }
    
    .like-btn:hover:not(:disabled){
      transform:translateY(-2px);
      box-shadow:0 6px 16px rgba(255,152,0,.45);
    }
    
    .like-btn:active:not(:disabled){
      transform:translateY(0);
    }
    
    .like-btn:disabled{
      opacity:.6;
      cursor:not-allowed;
      transform:none;
    }
    
    .like-btn:focus-visible{
      outline:3px solid var(--orange);
      outline-offset:2px;
    }
    
    .timestamp{
      color:var(--muted);
      font-size:14px;
    }
    
    .body-clamp{
      color:var(--text);
      font-size:16px;
      line-height:1.7;
      display:-webkit-box;
      -webkit-box-orient:vertical;
      -webkit-line-clamp:6;
      overflow:hidden;
    }
    
    @media (min-width:768px){
      .body-clamp{
        -webkit-line-clamp:8;
      }
    }

    /* Form Section */
    .form-wrap{
      padding:28px 24px;
    }
    
    .form-wrap h2{
      margin:0 0 24px;
      font-size:24px;
      font-weight:700;
      color:var(--text);
    }
    
    form{
      display:grid;
      gap:20px;
    }
    
    .row{
      display:grid;
      gap:8px;
    }
    
    label{
      font-weight:600;
      color:var(--text);
      font-size:15px;
    }
    
    input, textarea{
      padding:14px 16px;
      border:1px solid var(--border);
      border-radius:12px;
      background:var(--card);
      color:var(--text);
      font-size:16px;
      font-family:inherit;
      transition:all .2s ease;
    }
    
    input:focus, textarea:focus{
      outline:0;
      border-color:var(--primary);
      box-shadow:0 0 0 3px rgba(37,99,235,.1);
    }
    
    textarea{
      min-height:140px;
      resize:vertical;
    }
    
    .hp{
      position:absolute;
      left:-9999px;
    }
    
    .actions{
      display:flex;
      gap:16px;
      align-items:center;
      flex-wrap:wrap;
    }
    
    .btn-primary{
      min-height:48px;
      padding:12px 32px;
      border:0;
      background:linear-gradient(135deg, var(--primary), var(--primary-hover));
      color:#fff;
      font-weight:700;
      font-size:16px;
      border-radius:12px;
      cursor:pointer;
      transition:all .2s ease;
      box-shadow:0 4px 12px rgba(30,136,229,.35);
    }
    
    .btn-primary:hover:not(:disabled){
      transform:translateY(-2px);
      box-shadow:0 6px 16px rgba(30,136,229,.45);
    }
    
    .btn-primary:active:not(:disabled){
      transform:translateY(0);
    }
    
    .btn-primary:disabled{
      opacity:.6;
      cursor:not-allowed;
      transform:none;
    }
    
    .btn-primary:focus-visible{
      outline:3px solid var(--primary);
      outline-offset:2px;
    }
    
    .status{
      font-size:15px;
      font-weight:500;
    }
    
    .ok{
      color:#10b981;
    }
    
    .err{
      color:#ef4444;
    }

    /* Empty State */
    .empty-state{
      text-align:center;
      padding:48px 24px;
      color:var(--muted);
    }

    /* Inline Loading */
    .loading{
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      padding:24px;
      color:var(--muted);
    }
    
    .dot{
      width:8px;
      height:8px;
      border-radius:50%;
      background:currentColor;
      animation:blink 1.4s infinite ease-in-out;
    }
    
    .dot:nth-child(2){animation-delay:.2s}
    .dot:nth-child(3){animation-delay:.4s}
    
    @keyframes blink{
      0%,80%,100%{opacity:.2}
      40%{opacity:1}
    }

    /* Welcome Modal */
    .welcome-modal{
      position:fixed;
      top:0;
      left:0;
      width:100%;
      height:100%;
      background:rgba(0,0,0,.5);
      backdrop-filter:blur(4px);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:10000;
      opacity:0;
      pointer-events:none;
      transition:opacity .3s ease;
      padding:16px;
    }
    
    .welcome-modal.show{
      opacity:1;
      pointer-events:all;
    }
    
    .welcome-alert{
      background:#fff;
      border:2px solid var(--primary);
      border-radius:16px;
      padding:40px;
      max-width:500px;
      width:100%;
      box-shadow:0 20px 40px rgba(0,0,0,.3);
      text-align:center;
      transform:scale(0.9);
      transition:transform .3s cubic-bezier(.68,-.55,.265,1.55);
    }
    
    .welcome-modal.show .welcome-alert{
      transform:scale(1);
    }
    
    .welcome-alert-icon{
      width:64px;
      height:64px;
      background:linear-gradient(135deg, var(--primary), var(--primary-hover));
      border-radius:50%;
      display:flex;
      align-items:center;
      justify-content:center;
      margin:0 auto 20px;
      font-size:32px;
      color:#fff;
      font-weight:700;
    }
    
    .welcome-alert-title{
      font-size:28px;
      font-weight:700;
      color:var(--text);
      margin:0 0 16px;
    }
    
    .welcome-alert-message{
      font-size:17px;
      color:var(--muted);
      line-height:1.6;
      margin:0 0 28px;
    }
    
    .welcome-alert-btn{
      background:linear-gradient(135deg, var(--primary), var(--primary-hover));
      color:#fff;
      border:none;
      padding:14px 40px;
      border-radius:12px;
      font-weight:700;
      font-size:17px;
      cursor:pointer;
      transition:all .2s ease;
      box-shadow:0 4px 12px rgba(30,136,229,.35);
      width:100%;
    }
    
    .welcome-alert-btn:hover{
      transform:translateY(-2px);
      box-shadow:0 6px 16px rgba(30,136,229,.45);
    }
    
    .welcome-alert-btn:active{
      transform:translateY(0);
    }
    
    .welcome-alert-btn:focus-visible{
      outline:3px solid var(--primary);
      outline-offset:2px;
    }
    
    @media (max-width:640px){
      .welcome-alert{
        padding:32px 24px;
      }
      
      .welcome-alert-icon{
        width:56px;
        height:56px;
        font-size:28px;
      }
      
      .welcome-alert-title{
        font-size:24px;
      }
      
      .welcome-alert-message{
        font-size:16px;
      }
    }

    /* Toast Notification */
    .toast{
      position:fixed;
      top:24px;
      right:24px;
      background:#fff;
      border:2px solid var(--border);
      border-radius:12px;
      padding:16px 20px;
      box-shadow:0 10px 25px rgba(30,136,229,.25);
      display:flex;
      align-items:center;
      gap:12px;
      z-index:10000;
      opacity:0;
      transform:translateX(400px);
      transition:all .4s cubic-bezier(.68,-.55,.265,1.55);
      max-width:calc(100vw - 48px);
    }
    
    .toast.show{
      opacity:1;
      transform:translateX(0);
    }
    
    .toast.success{
      border-color:#4caf50;
      background:linear-gradient(135deg, #ffffff, #f1f8f4);
    }
    
    .toast.success .toast-icon{
      color:#4caf50;
      font-size:24px;
    }
    
    .toast.like{
      border-color:var(--orange);
      background:linear-gradient(135deg, #ffffff, var(--orange-light));
    }
    
    .toast.like .toast-icon{
      color:var(--orange);
      font-size:24px;
      animation:heartbeat .6s ease;
    }
    
    @keyframes heartbeat{
      0%, 100%{transform:scale(1)}
      25%{transform:scale(1.3)}
      50%{transform:scale(1.1)}
    }
    
    .toast-content{
      flex:1;
    }
    
    .toast-title{
      font-weight:700;
      color:var(--text);
      margin:0 0 4px;
      font-size:15px;
    }
    
    .toast-message{
      color:var(--muted);
      margin:0;
      font-size:14px;
    }
    
    .toast-close{
      background:none;
      border:none;
      color:var(--muted);
      cursor:pointer;
      font-size:20px;
      padding:4px;
      line-height:1;
      transition:color .2s ease;
    }
    
    .toast-close:hover{
      color:var(--text);
    }
    
    @media (max-width:640px){
      .toast{
        top:16px;
        right:16px;
        left:16px;
        max-width:none;
      }
    }
  </style>
</head>
<body>
  <!-- Snowflakes Canvas -->
  <canvas id="snowCanvas"></canvas>

  <!-- Loading Overlay -->
  <div id="loadingOverlay">
    <div class="loader">
      <div class="spinner"></div>
      <div class="loader-text">Caricamento...</div>
    </div>
  </div>

  <main class="container">
    <!-- Carousel Section -->
    <section class="panel" aria-label="Suggerimenti esistenti">
      <div class="section-head">
        <h2>Suggerimenti</h2>
        <div class="controls">
          <button id="prevBtn" type="button" class="ctrl-btn" aria-label="Precedente">◀</button>
          <button id="nextBtn" type="button" class="ctrl-btn" aria-label="Successivo">▶</button>
        </div>
      </div>
      <div id="cardsLoading" class="loading" style="display:none" aria-live="polite">
        <span>Caricamento</span>
        <span class="dot"></span>
        <span class="dot"></span>
        <span class="dot"></span>
      </div>
      <div id="carousel" class="carousel" aria-live="polite">
        <div id="track" class="track"></div>
      </div>
    </section>

    <!-- Form Section -->
    <section class="panel form-wrap" aria-label="Inserisci nuovo suggerimento">
      <h2>Inserisci suggerimento</h2>
      <form id="f"
            action="https://script.google.com/macros/s/AKfycbwc4nU2fI4V65xhwER1tIsaxC5eHHqUPY2xKEVTh4FaYtNxGjLlC4TvoxqiFi5UPKMJ/exec"
            method="POST" target="sink" novalidate autocomplete="off">
        <input type="hidden" name="op" value="save">
        <input class="hp" type="text" name="website" tabindex="-1" autocomplete="off">

        <div class="row">
          <label for="titolo">Titolo</label>
          <input type="text" id="titolo" name="titolo" required placeholder="Inserisci un titolo...">
        </div>

        <div class="row">
          <label for="suggerimento">Suggerimento</label>
          <textarea id="suggerimento" name="suggerimento" required placeholder="Descrivi il tuo suggerimento..."></textarea>
        </div>

        <div class="actions">
          <button type="submit" id="btn" class="btn-primary">Invia suggerimento</button>
          <div id="msg" class="status" aria-live="polite"></div>
        </div>
      </form>
    </section>
  </main>

  <iframe name="sink" style="display:none"></iframe>

  <!-- Toast Container -->
  <div id="toastContainer"></div>

  <!-- Welcome Modal -->
  <div id="welcomeModal" class="welcome-modal">
    <div class="welcome-alert">
      <div class="welcome-alert-icon">i</div>
      <h2 class="welcome-alert-title">Benvenuto!</h2>
      <p class="welcome-alert-message">Aiutaci nello sviluppo del nuovo sito web APECS con qualche suggerimento</p>
      <button id="welcomeBtn" class="welcome-alert-btn">Va bene!</button>
    </div>
  </div>

  <script>
    const API = "https://script.google.com/macros/s/AKfycbwc4nU2fI4V65xhwER1tIsaxC5eHHqUPY2xKEVTh4FaYtNxGjLlC4TvoxqiFi5UPKMJ/exec";

    const f = document.getElementById('f');
    const msg = document.getElementById('msg');
    const btn = document.getElementById('btn');
    const sink = document.querySelector('iframe[name="sink"]');
    const loadingOverlay = document.getElementById('loadingOverlay');
    const toastContainer = document.getElementById('toastContainer');
    const welcomeModal = document.getElementById('welcomeModal');
    const welcomeBtn = document.getElementById('welcomeBtn');

    const carousel = document.getElementById('carousel');
    const track = document.getElementById('track');
    const cardsLoading = document.getElementById('cardsLoading');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');

    let lastOp = null;
    let slides = [];
    let slideH = 0;
    let cur = 0;
    let timer = null;
    let resumeTimer = null;

    // Toast Notification System
    function showToast(type, title, message, duration = 4000) {
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      
      const icons = {
        success: '✓',
        like: '♥',
        info: 'i'
      };
      const icon = icons[type] || 'i';
      
      toast.innerHTML = `
        <div class="toast-icon">${icon}</div>
        <div class="toast-content">
          <div class="toast-title">${title}</div>
          <div class="toast-message">${message}</div>
        </div>
        <button class="toast-close" aria-label="Chiudi">×</button>
      `;
      
      toastContainer.appendChild(toast);
      
      // Trigger animation
      setTimeout(() => toast.classList.add('show'), 10);
      
      // Close button
      const closeBtn = toast.querySelector('.toast-close');
      closeBtn.addEventListener('click', () => removeToast(toast));
      
      // Auto remove
      setTimeout(() => removeToast(toast), duration);
    }
    
    function removeToast(toast) {
      toast.classList.remove('show');
      setTimeout(() => toast.remove(), 400);
    }

    // Welcome Modal
    function showWelcomeModal() {
      setTimeout(() => {
        welcomeModal.classList.add('show');
      }, 500);
    }
    
    function hideWelcomeModal() {
      welcomeModal.classList.remove('show');
    }
    
    welcomeBtn.addEventListener('click', hideWelcomeModal);

    // Snowflakes Animation
    const canvas = document.getElementById('snowCanvas');
    const ctx = canvas.getContext('2d');
    let snowflakes = [];

    function resizeCanvas() {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
    }

    class Snowflake {
      constructor() {
        this.x = Math.random() * canvas.width;
        this.y = Math.random() * canvas.height - canvas.height;
        this.radius = Math.random() * 3 + 1;
        this.speed = Math.random() * 1 + 0.5;
        this.wind = Math.random() * 0.5 - 0.25;
        this.opacity = Math.random() * 0.6 + 0.3;
      }

      update() {
        this.y += this.speed;
        this.x += this.wind;

        if (this.y > canvas.height) {
          this.y = -10;
          this.x = Math.random() * canvas.width;
        }

        if (this.x > canvas.width) {
          this.x = 0;
        } else if (this.x < 0) {
          this.x = canvas.width;
        }
      }

      draw() {
        ctx.beginPath();
        ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
        ctx.fillStyle = `rgba(30, 136, 229, ${this.opacity * 0.6})`;
        ctx.fill();
      }
    }

    function initSnowflakes() {
      snowflakes = [];
      const count = Math.min(Math.floor((canvas.width * canvas.height) / 8000), 100);
      for (let i = 0; i < count; i++) {
        snowflakes.push(new Snowflake());
      }
    }

    function animateSnow() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      snowflakes.forEach(flake => {
        flake.update();
        flake.draw();
      });
      requestAnimationFrame(animateSnow);
    }

    resizeCanvas();
    initSnowflakes();
    animateSnow();

    window.addEventListener('resize', () => {
      resizeCanvas();
      initSnowflakes();
    });

    // Loading Overlay
    function showLoading() {
      loadingOverlay.classList.add('show');
    }

    function hideLoading() {
      loadingOverlay.classList.remove('show');
    }

    const setMsg = (t, cls='') => { 
      msg.textContent = t; 
      msg.className = 'status ' + cls; 
    };

    const escapeHtml = s => String(s ?? '')
      .replace(/&/g,'&amp;').replace(/</g,'&lt;')
      .replace(/>/g,'&gt;').replace(/"/g,'&quot;')
      .replace(/'/g,'&#39;');

    const fmtTs = v => {
      if (!v) return '';
      if (typeof v === 'number') {
        const ms = Math.round((v - 25569) * 86400 * 1000);
        return new Date(ms).toLocaleString('it-IT', { timeZone: 'Europe/Oslo' });
      }
      const d = new Date(String(v).replace(' ', 'T'));
      return isNaN(d) ? '' : d.toLocaleString('it-IT', { timeZone: 'Europe/Oslo' });
    };

    function setCardsLoading(on) {
      cardsLoading.style.display = on ? 'flex' : 'none';
      if (on) { track.innerHTML = ''; stopAuto(); }
    }

    async function loadAll() {
      try {
        setCardsLoading(true);
        const r = await fetch(`${API}?op=all`, { method: 'GET' });
        const j = await r.json();
        if (!j.ok) throw new Error(j.message || 'Errore lettura');
        renderCards(j.rows || []);
      } catch (err) {
        track.innerHTML = `<div class="card"><div class="empty-state"><div class="empty-state-icon">⚠️</div><p>Errore: ${escapeHtml(err.message)}</p></div></div>`;
      } finally {
        setCardsLoading(false);
      }
    }

    function renderCards(rows) {
      if (!rows.length) {
        track.innerHTML = '<div class="card"><div class="empty-state"><p>Nessun suggerimento presente.</p><p>Sii il primo a inserirne uno!</p></div></div>';
        calibrate(); 
        updateControlsState(); 
        return;
      }
      
      const norm = rows.map((o) => ({
        _row: o._row,
        titolo: o.titolo,
        suggerimento: o.suggerimento,
        likes: Number(o.numero_like ?? o.likes ?? 0),
        ts: o.timestamp
      }));
      
      norm.sort((a,b) => (b.likes - a.likes) || (new Date(b.ts) - new Date(a.ts)));

      track.innerHTML = norm.map(o => `
        <article class="card">
          <h3>${escapeHtml(o.titolo)}</h3>
          <div class="meta">
            <span class="pill">Like: ${o.likes}</span>
            <button type="button" class="like-btn" data-row="${o._row}">Metti like</button>
            <span class="timestamp">${fmtTs(o.ts)}</span>
          </div>
          <p class="body-clamp">${escapeHtml(o.suggerimento)}</p>
        </article>`).join('');

      calibrate();
      startAuto();
      updateControlsState();
    }

    function calibrate() {
      slides = Array.from(track.children);
      if (slides.length === 0) { 
        slideH = 0; 
        carousel.style.height = 'auto'; 
        return; 
      }
      
      let maxH = 0;
      slides.forEach(s => { 
        s.style.height = 'auto'; 
        maxH = Math.max(maxH, s.offsetHeight); 
      });
      slides.forEach(s => { 
        s.style.height = maxH + 'px'; 
      });
      
      slideH = Math.min(maxH, carousel.clientHeight || maxH);
      carousel.style.height = slideH + 'px';
      cur = 0;
      track.style.transform = 'translateY(0)';
    }

    function goTo(i) {
      if (slides.length === 0 || slideH === 0) return;
      cur = ((i % slides.length) + slides.length) % slides.length;
      track.style.transform = `translateY(-${cur * slideH}px)`;
      updateControlsState();
    }

    function next() { goTo(cur + 1); }
    function prev() { goTo(cur - 1); }

    function startAuto() {
      stopAuto();
      if (slides.length <= 1) return;
      timer = setInterval(next, 10000);
    }
    
    function stopAuto() {
      if (timer) { clearInterval(timer); timer = null; }
      if (resumeTimer) { clearTimeout(resumeTimer); resumeTimer = null; }
    }
    
    function pauseAndResume() {
      stopAuto();
      if (slides.length > 1) resumeTimer = setTimeout(() => startAuto(), 15000);
    }

    function updateControlsState() {
      const disabled = slides.length <= 1;
      prevBtn.disabled = disabled; 
      nextBtn.disabled = disabled;
    }

    track.addEventListener('click', (e) => {
      const btnLike = e.target.closest('.like-btn');
      if (!btnLike) return;
      const row = Number(btnLike.dataset.row);
      submitLike(row, btnLike);
      pauseAndResume();
    });

    prevBtn.addEventListener('click', () => { prev(); pauseAndResume(); });
    nextBtn.addEventListener('click', () => { next(); pauseAndResume(); });
    
    document.addEventListener('keydown', (e) => {
      if (e.key === 'ArrowLeft') { prev(); pauseAndResume(); }
      if (e.key === 'ArrowRight') { next(); pauseAndResume(); }
    });
    
    window.addEventListener('resize', () => calibrate());
    
    document.addEventListener('visibilitychange', () => { 
      if (document.hidden) stopAuto(); 
      else startAuto(); 
    });

    function submitLike(row, btnEl) {
      if (!row || row < 2) return;
      if (btnEl) { 
        btnEl.disabled = true; 
        btnEl.textContent = '⏳ ...'; 
      }
      lastOp = 'like';
      showLoading();
      
      const form = document.createElement('form');
      form.action = API; 
      form.method = 'POST'; 
      form.target = 'sink'; 
      form.style.display = 'none';
      const op = document.createElement('input'); 
      op.name = 'op'; 
      op.value = 'like'; 
      form.appendChild(op);
      const r = document.createElement('input'); 
      r.name = 'row'; 
      r.value = String(row); 
      form.appendChild(r);
      document.body.appendChild(form); 
      form.submit(); 
      setTimeout(() => form.remove(), 0);
      
      // Show toast notification
      showToast('like', 'Like aggiunto!', 'Grazie per il tuo supporto');
    }

    f.addEventListener('submit', (e) => {
      if (f.website && f.website.value) { 
        e.preventDefault(); 
        setMsg('Bloccato', 'err'); 
        return; 
      }
      if (!f.titolo.value.trim() || !f.suggerimento.value.trim()) { 
        e.preventDefault(); 
        setMsg('Compila tutti i campi obbligatori', 'err'); 
        return; 
      }
      setMsg('Invio in corso…'); 
      btn.disabled = true; 
      lastOp = 'save'; 
      showLoading();
      pauseAndResume();
    });

    sink.addEventListener('load', () => {
      hideLoading();
      if (lastOp === 'save') { 
        setMsg('✓ Suggerimento inserito con successo!', 'ok'); 
        f.reset(); 
        btn.disabled = false;
        showToast('success', 'Suggerimento inviato!', 'Il tuo suggerimento è stato aggiunto con successo');
      }
      loadAll(); 
      lastOp = null;
    });

    document.addEventListener('DOMContentLoaded', () => {
      showLoading();
      loadAll().then(() => {
        hideLoading();
        showWelcomeModal();
      });
    });
  </script>
</body>
</html>