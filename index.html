<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <title>Suggerimenti</title>
  <style>
    :root{
      --bg:#ffffff; --card:#ffffff; --text:#0f2a3a; --muted:#5b7686;
      --blue-700:#0b3d6d; --orange-500:#ff7a1a;
      --ring: rgba(0,0,0,.2);
      --radius:14px; --gap:14px;
      --shadow: 0 8px 24px rgba(0,0,0,.06);
      --border: 1px solid #e6e6e6; /* neutro, niente azzurro */
    }
    @media (prefers-color-scheme: dark){
      :root{
        --bg:#0e0e10; --card:#141418; --text:#eef7ff; --muted:#a9b4bd;
        --blue-700:#9fd0ff; --orange-500:#ffa559;
        --ring: rgba(255,255,255,.3);
        --border:1px solid #2a2a2f; --shadow: 0 10px 30px rgba(0,0,0,.45);
      }
    }
    *{box-sizing:border-box; -webkit-tap-highlight-color: transparent}
    html,body{height:100%}
    body{
      margin:0; font-family: system-ui, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text); background: var(--bg); line-height:1.4;
    }
    .container{ max-width:920px; margin:0 auto; padding: 12px clamp(12px,4vw,20px); }

    /* Pannelli puliti, senza gradienti o bordi azzurri */
    .panel{
      margin: clamp(12px,3.5vw,18px) 0;
      background: var(--card);
      border: var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: clip;
    }

    /* Testate sezioni */
    .section-head{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding: 12px clamp(12px,3.2vw,16px);
      border-bottom: var(--border);
      background: transparent; /* no gradient */
    }
    .section-head h2{ margin:0; font-size: clamp(1rem,3.4vw,1.1rem); color: var(--blue-700); }

    /* Carousel */
    .carousel{ position: relative; overflow: hidden; max-height: 48vh; }
    @media (min-width: 700px){ .carousel{ max-height: 56vh; } }
    .track{ display:flex; flex-direction:column; will-change: transform; transition: transform .6s cubic-bezier(.22,.61,.36,1); }

    .card{ padding: 14px clamp(12px,3.2vw,16px); border-bottom: var(--border); background: var(--card); }
    .card:last-child{ border-bottom: 0; }
    .card h3{ margin:0 0 6px; font-size: clamp(1rem,3.6vw,1.08rem) }
    .meta{ display:flex; align-items:center; gap:10px; margin: 2px 0 8px; color:var(--muted); font-size:.95rem; }
    .pill{
      display:inline-flex; align-items:center; gap:6px; padding: 6px 12px; border-radius:999px;
      border:1px solid #e6e6e6; background:#fff;
    }
    .pill b{ color: var(--blue-700); }

    .like-btn{
      min-height:44px; border:1px solid #e6e6e6; /* neutro */
      background:#fff4ea; color:#7a3b00; border-radius: 12px; padding: 8px 12px;
      cursor:pointer; font-weight:700; transition: transform .06s ease; touch-action: manipulation;
    }
    .like-btn:hover{ transform: translateY(-1px) }
    .like-btn[disabled]{ opacity:.6; cursor:default; transform:none }
    .like-btn:focus-visible{ outline: 3px solid var(--ring); outline-offset: 2px; }

    .body-clamp{ display:-webkit-box; -webkit-box-orient: vertical; -webkit-line-clamp: 6; overflow: hidden; }
    @media (min-width:700px){ .body-clamp{ -webkit-line-clamp: 10; } }

    /* Controlli */
    .controls{ display:flex; gap:10px; }
    .ctrl-btn{
      min-height: 44px; min-width: 44px;
      border:1px solid #e6e6e6; background:#ffffff; color:#222;
      border-radius: 999px; padding: 8px 12px; cursor: pointer; font-weight:700; font-size: 1rem;
      box-shadow: 0 2px 8px rgba(0,0,0,.06);
    }
    .ctrl-btn:disabled{ opacity:.45; cursor:default }
    .ctrl-btn:focus-visible{ outline: 3px solid var(--ring); outline-offset: 2px; }

    /* Form */
    .form-wrap{ padding: clamp(12px,3.6vw,16px); }
    form{ display:grid; gap: 12px; }
    .row{ display:grid; gap:6px; }
    label{ font-weight:800; color: var(--blue-700); font-size: .98rem; }
    input, textarea{
      padding: 12px; border-radius: 12px; border: var(--border); background:#fff;
      font-size:1rem; color:var(--text);
    }
    textarea{ min-height: 120px; resize: vertical; }
    input:focus-visible, textarea:focus-visible{ outline: 3px solid var(--ring); outline-offset: 2px; }

    .actions{ display:flex; gap:10px; align-items:center; flex-wrap: wrap; }
    .btn-primary{
      min-height: 44px; border: 0; background: linear-gradient(180deg, var(--orange-500), #ff6a00);
      color:#fff; font-weight:800; padding: 10px 16px; border-radius: 14px; cursor:pointer;
      box-shadow: 0 6px 16px rgba(255,122,26,.26); touch-action: manipulation;
    }
    .btn-primary:disabled{ opacity:.6; cursor: default }
    .status{ font-size:.95rem }
    .ok{ color:#0a6 } .err{ color:#b00 }

    /* Loading */
    .loading{ display:inline-flex; align-items:center; gap:8px; color:#666; padding: 10px 14px; }
    .dot{ width:6px; height:6px; border-radius:50%; background: currentColor; display:inline-block; animation: blink 1s infinite ease-in-out; }
    .dot:nth-child(2){ animation-delay:.2s } .dot:nth-child(3){ animation-delay:.4s }
    @keyframes blink{ 0%,80%,100%{opacity:.2} 40%{opacity:1} }

    /* Spazio basso sicuro su iOS */
    main{ padding-bottom: calc(12px + env(safe-area-inset-bottom)); }
  </style>
</head>
<body>
  <main class="container">
    <!-- Carosello senza header -->
    <section class="panel" aria-label="Suggerimenti esistenti">
      <div class="section-head">
        <h2>Suggerimenti</h2>
        <div class="controls">
          <button id="prevBtn" type="button" class="ctrl-btn" aria-label="Indietro">‚óÄ</button>
          <button id="nextBtn" type="button" class="ctrl-btn" aria-label="Avanti">‚ñ∂</button>
        </div>
      </div>
      <div id="cardsLoading" class="loading" style="display:none" aria-live="polite">
        <span>Caricamento</span><span class="dot"></span><span class="dot"></span><span class="dot"></span>
      </div>
      <div id="carousel" class="carousel" aria-live="polite">
        <div id="track" class="track"></div>
      </div>
    </section>

    <!-- Form -->
    <section class="panel form-wrap" aria-label="Inserisci nuovo suggerimento">
      <h2 style="margin:0 0 8px; color:var(--blue-700); font-size: clamp(1rem,3.6vw,1.2rem)">Inserisci suggerimento</h2>
      <form id="f"
            action="https://script.google.com/macros/s/AKfycbwc4nU2fI4V65xhwER1tIsaxC5eHHqUPY2xKEVTh4FaYtNxGjLlC4TvoxqiFi5UPKMJ/exec"
            method="POST" target="sink" novalidate autocomplete="off">
        <input type="hidden" name="op" value="save">
        <input class="hp" type="text" name="website" tabindex="-1" autocomplete="off">

        <div class="row">
          <label for="titolo">Titolo</label>
          <input type="text" id="titolo" name="titolo" required inputmode="text" autocomplete="off">
        </div>

        <div class="row">
          <label for="suggerimento">Suggerimento</label>
          <textarea id="suggerimento" name="suggerimento" required></textarea>
        </div>

        <div class="actions">
          <button type="submit" id="btn" class="btn-primary">Invia suggerimento</button>
          <div id="msg" class="status" aria-live="polite"></div>
        </div>
      </form>
    </section>
  </main>

  <!-- Iframe nascosto per evitare CORS sul POST -->
  <iframe name="sink" style="display:none"></iframe>

  <script>
    const API = "https://script.google.com/macros/s/AKfycbwc4nU2fI4V65xhwER1tIsaxC5eHHqUPY2xKEVTh4FaYtNxGjLlC4TvoxqiFi5UPKMJ/exec";

    const f = document.getElementById('f');
    const msg = document.getElementById('msg');
    const btn = document.getElementById('btn');
    const sink = document.querySelector('iframe[name="sink"]');

    const carousel = document.getElementById('carousel');
    const track = document.getElementById('track');
    const cardsLoading = document.getElementById('cardsLoading');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');

    let lastOp = null; // 'save' | 'like'
    let slides = [];
    let slideH = 0;
    let cur = 0;
    let timer = null;
    let resumeTimer = null;

    const setMsg = (t, cls='') => { msg.textContent = t; msg.className = 'status ' + cls; };

    const escapeHtml = s => String(s ?? '')
      .replace(/&/g,'&amp;').replace(/</g,'&lt;')
      .replace(/>/g,'&gt;').replace(/"/g,'&quot;')
      .replace(/'/g,'&#39;');

    const fmtTs = v => {
      if (!v) return '';
      if (typeof v === 'number') {
        const ms = Math.round((v - 25569) * 86400 * 1000);
        return new Date(ms).toLocaleString('it-IT', { timeZone: 'Europe/Oslo' });
      }
      const d = new Date(String(v).replace(' ', 'T'));
      return isNaN(d) ? '' : d.toLocaleString('it-IT', { timeZone: 'Europe/Oslo' });
    };

    function setCardsLoading(on) {
      cardsLoading.style.display = on ? 'inline-flex' : 'none';
      if (on) { track.innerHTML = ''; stopAuto(); }
    }

    async function loadAll() {
      try {
        setCardsLoading(true);
        const r = await fetch(`${API}?op=all`, { method: 'GET' });
        const j = await r.json();
        if (!j.ok) throw new Error(j.message || 'Errore lettura');
        renderCards(j.rows || []);
      } catch (err) {
        track.innerHTML = `<div class="card"><div class="meta">Errore</div><p>${escapeHtml(err.message)}</p></div>`;
      } finally {
        setCardsLoading(false);
      }
    }

    function renderCards(rows) {
      if (!rows.length) {
        track.innerHTML = '<div class="card"><p>Nessun suggerimento presente.</p></div>';
        calibrate(); updateControlsState(); return;
      }
      const norm = rows.map((o) => ({
        _row: o._row,
        titolo: o.titolo,
        suggerimento: o.suggerimento,
        likes: Number(o.numero_like ?? o.likes ?? 0),
        ts: o.timestamp
      }));
      norm.sort((a,b) => (b.likes - a.likes) || (new Date(b.ts) - new Date(a.ts)));

      track.innerHTML = norm.map(o => `
        <article class="card">
          <h3>${escapeHtml(o.titolo)}</h3>
          <div class="meta">
            <span class="pill">üëç <b>${o.likes}</b></span>
            <button type="button" class="like-btn" data-row="${o._row}">Metti like</button>
            <span>¬∑ ${fmtTs(o.ts)}</span>
          </div>
          <p class="body-clamp">${escapeHtml(o.suggerimento)}</p>
        </article>`).join('');

      calibrate();
      startAuto();
      updateControlsState();
    }

    function calibrate() {
      slides = Array.from(track.children);
      if (slides.length === 0) { slideH = 0; carousel.style.height = 'auto'; return; }
      let maxH = 0;
      slides.forEach(s => { s.style.height = 'auto'; maxH = Math.max(maxH, s.offsetHeight); });
      slides.forEach(s => { s.style.height = maxH + 'px'; });
      slideH = Math.min(maxH, carousel.clientHeight || maxH);
      carousel.style.height = slideH + 'px';
      cur = 0;
      track.style.transform = 'translateY(0)';
    }

    function goTo(i) {
      if (slides.length === 0 || slideH === 0) return;
      cur = ((i % slides.length) + slides.length) % slides.length;
      track.style.transform = `translateY(-${cur * slideH}px)`;
      updateControlsState();
    }

    function next() { goTo(cur + 1); }
    function prev() { goTo(cur - 1); }

    function startAuto() {
      stopAuto();
      if (slides.length <= 1) return;
      timer = setInterval(next, 10000); // 10s
    }
    function stopAuto() {
      if (timer) { clearInterval(timer); timer = null; }
      if (resumeTimer) { clearTimeout(resumeTimer); resumeTimer = null; }
    }
    function pauseAndResume() {
      stopAuto();
      if (slides.length > 1) resumeTimer = setTimeout(() => startAuto(), 15000);
    }

    function updateControlsState() {
      const disabled = slides.length <= 1;
      prevBtn.disabled = disabled; nextBtn.disabled = disabled;
    }

    // Like
    track.addEventListener('click', (e) => {
      const btnLike = e.target.closest('.like-btn');
      if (!btnLike) return;
      const row = Number(btnLike.dataset.row);
      submitLike(row, btnLike);
      pauseAndResume();
    });

    // Controlli
    prevBtn.addEventListener('click', () => { prev(); pauseAndResume(); });
    nextBtn.addEventListener('click', () => { next(); pauseAndResume(); });
    document.addEventListener('keydown', (e) => {
      if (e.key === 'ArrowLeft') { prev(); pauseAndResume(); }
      if (e.key === 'ArrowRight') { next(); pauseAndResume(); }
    });
    window.addEventListener('resize', () => calibrate());
    document.addEventListener('visibilitychange', () => { if (document.hidden) stopAuto(); else startAuto(); });

    // Invio like via form nell'iframe (CORS-safe)
    function submitLike(row, btnEl) {
      if (!row || row < 2) return;
      if (btnEl) { btnEl.disabled = true; btnEl.textContent = '...'; }
      lastOp = 'like';
      const form = document.createElement('form');
      form.action = API; form.method = 'POST'; form.target = 'sink'; form.style.display = 'none';
      const op = document.createElement('input'); op.name = 'op'; op.value = 'like'; form.appendChild(op);
      const r = document.createElement('input'); r.name = 'row'; r.value = String(row); form.appendChild(r);
      document.body.appendChild(form); form.submit(); setTimeout(() => form.remove(), 0);
    }

    // Submit form
    f.addEventListener('submit', (e) => {
      if (f.website && f.website.value) { e.preventDefault(); setMsg('Bloccato', 'err'); return; }
      if (!f.titolo.value.trim() || !f.suggerimento.value.trim()) { e.preventDefault(); setMsg('Compila i campi obbligatori', 'err'); return; }
      setMsg('Invio in corso‚Ä¶'); btn.disabled = true; lastOp = 'save'; pauseAndResume();
    });

    // Iframe response
    sink.addEventListener('load', () => {
      if (lastOp === 'save') { setMsg('Inserito correttamente', 'ok'); f.reset(); btn.disabled = false; }
      loadAll(); lastOp = null;
    });

    document.addEventListener('DOMContentLoaded', loadAll);
  </script>
</body>
</html>
