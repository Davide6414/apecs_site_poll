<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Suggerimenti</title>
  <style>
    body { font-family: system-ui, Segoe UI, Roboto, Arial, sans-serif; max-width: 720px; margin: 24px auto; padding: 0 12px; }
    form { display: grid; gap: 12px; }
    label { font-weight: 600; }
    input, textarea, button { padding: 8px; font-size: 1rem; }
    textarea { resize: vertical; min-height: 100px; }
    .row { display: grid; gap: 6px; }
    .msg { margin-top: 10px; font-size: .95rem; }
    .ok { color: #0a6; }
    .err { color: #b00; }
    .hp { position: absolute; left: -9999px; top: -9999px; }

    /* carousel */
    .carousel-wrap { margin-bottom: 24px; position: relative; }
    .carousel-title { margin: 0 0 8px; font-size: 1.2rem; }
    .carousel { position: relative; overflow: hidden; border: 1px solid #e3e3e3; border-radius: 12px; background: #fff; }
    .track { display: flex; flex-direction: column; will-change: transform; transition: transform .6s ease-in-out; }
    .card { box-sizing: border-box; border-bottom: 1px solid #eee; padding: 14px 12px; }
    .card:last-child { border-bottom: 0; }
    .card h3 { margin: 0 0 6px; font-size: 1.05rem; }
    .meta { font-size: .9rem; color: #555; margin-bottom: 6px; display: flex; align-items: center; gap: 8px; }
    .like-btn { border: 1px solid #ddd; background: #f7f7f7; border-radius: 8px; padding: 4px 8px; cursor: pointer; }
    .like-btn[disabled] { opacity: .6; cursor: default; }

    /* controls */
    .controls { position: absolute; inset: 0; pointer-events: none; }
    .ctrl-btn {
      pointer-events: auto; position: absolute; top: 50%; transform: translateY(-50%);
      border: 1px solid #ddd; background: rgba(255,255,255,.9); border-radius: 999px;
      padding: 8px 12px; cursor: pointer; box-shadow: 0 1px 4px rgba(0,0,0,.06);
    }
    .ctrl-prev { left: 8px; }
    .ctrl-next { right: 8px; }
    .ctrl-btn[disabled] { opacity: .5; cursor: default; }

    /* loading */
    .loading { display: inline-flex; align-items: center; gap: 8px; color: #555; margin: 8px 0 16px; }
    .dot { width: 6px; height: 6px; border-radius: 50%; background: currentColor; display: inline-block; animation: blink 1s infinite ease-in-out; }
    .dot:nth-child(2) { animation-delay: .2s; }
    .dot:nth-child(3) { animation-delay: .4s; }
    @keyframes blink { 0%,80%,100%{ opacity:.2 } 40%{ opacity:1 } }
  </style>
</head>
<body>
  <div class="carousel-wrap">
    <h2 class="carousel-title">Suggerimenti</h2>
    <div id="cardsLoading" class="loading" style="display:none" aria-live="polite">
      <span>Caricamento</span><span class="dot"></span><span class="dot"></span><span class="dot"></span>
    </div>
    <div id="carousel" class="carousel" aria-live="polite">
      <div id="track" class="track"></div>
      <div class="controls" aria-hidden="false">
        <button id="prevBtn" type="button" class="ctrl-btn ctrl-prev" aria-label="Indietro">‚óÄ</button>
        <button id="nextBtn" type="button" class="ctrl-btn ctrl-next" aria-label="Avanti">‚ñ∂</button>
      </div>
    </div>
  </div>

  <h1>Inserisci suggerimento</h1>
  <form id="f"
        action="https://script.google.com/macros/s/AKfycbwc4nU2fI4V65xhwER1tIsaxC5eHHqUPY2xKEVTh4FaYtNxGjLlC4TvoxqiFi5UPKMJ/exec"
        method="POST" target="sink" novalidate autocomplete="off">
    <input type="hidden" name="op" value="save">
    <input class="hp" type="text" name="website" tabindex="-1" autocomplete="off">

    <div class="row">
      <label for="titolo">Titolo</label>
      <input type="text" id="titolo" name="titolo" required>
    </div>

    <div class="row">
      <label for="suggerimento">Suggerimento</label>
      <textarea id="suggerimento" name="suggerimento" required></textarea>
    </div>

    <button type="submit" id="btn">Invia</button>
    <div id="msg" class="msg" aria-live="polite"></div>
  </form>

  <iframe name="sink" style="display:none"></iframe>

  <script>
    const API = "https://script.google.com/macros/s/AKfycbwc4nU2fI4V65xhwER1tIsaxC5eHHqUPY2xKEVTh4FaYtNxGjLlC4TvoxqiFi5UPKMJ/exec";

    const f = document.getElementById('f');
    const msg = document.getElementById('msg');
    const btn = document.getElementById('btn');
    const sink = document.querySelector('iframe[name="sink"]');

    const carousel = document.getElementById('carousel');
    const track = document.getElementById('track');
    const cardsLoading = document.getElementById('cardsLoading');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');

    let lastOp = null; // 'save' | 'like'
    let slides = [];
    let slideH = 0;
    let cur = 0;
    let timer = null;
    let resumeTimer = null;

    const setMsg = (t, cls='') => { msg.textContent = t; msg.className = 'msg ' + cls; };

    const escapeHtml = s => String(s ?? '')
      .replace(/&/g,'&amp;').replace(/</g,'&lt;')
      .replace(/>/g,'&gt;').replace(/"/g,'&quot;')
      .replace(/'/g,'&#39;');

    const fmtTs = v => {
      if (!v) return '';
      if (typeof v === 'number') {
        const ms = Math.round((v - 25569) * 86400 * 1000);
        return new Date(ms).toLocaleString('it-IT', { timeZone: 'Europe/Oslo' });
      }
      const d = new Date(String(v).replace(' ', 'T'));
      return isNaN(d) ? '' : d.toLocaleString('it-IT', { timeZone: 'Europe/Oslo' });
    };

    function setCardsLoading(on) {
      cardsLoading.style.display = on ? 'inline-flex' : 'none';
      if (on) { track.innerHTML = ''; stopAuto(); }
    }

    async function loadAll() {
      try {
        setCardsLoading(true);
        const r = await fetch(`${API}?op=all`, { method: 'GET' });
        const j = await r.json();
        if (!j.ok) throw new Error(j.message || 'Errore lettura');
        renderCards(j.rows || []);
      } catch (err) {
        track.innerHTML = `<div class="card"><div class="meta">Errore</div><p>${escapeHtml(err.message)}</p></div>`;
      } finally {
        setCardsLoading(false);
      }
    }

    function renderCards(rows) {
      if (!rows.length) {
        track.innerHTML = '<div class="card"><p>Nessun suggerimento presente.</p></div>';
        calibrate();
        return;
      }
      const norm = rows.map((o) => ({
        _row: o._row,
        titolo: o.titolo,
        suggerimento: o.suggerimento,
        likes: Number(o.numero_like ?? o.likes ?? 0),
        ts: o.timestamp
      }));
      norm.sort((a,b) => (b.likes - a.likes) || (new Date(b.ts) - new Date(a.ts)));

      track.innerHTML = norm.map(o => `
        <article class="card">
          <h3>${escapeHtml(o.titolo)}</h3>
          <div class="meta">
            <span>üëç <strong>${o.likes}</strong></span>
            <button type="button" class="like-btn" data-row="${o._row}">Metti like</button>
            <span>¬∑ ${fmtTs(o.ts)}</span>
          </div>
          <p>${escapeHtml(o.suggerimento)}</p>
        </article>`).join('');

      calibrate();
      startAuto();
      updateControlsState();
    }

    function calibrate() {
      slides = Array.from(track.children);
      if (slides.length === 0) { slideH = 0; carousel.style.height = 'auto'; return; }
      let maxH = 0;
      slides.forEach(s => { s.style.height = 'auto'; maxH = Math.max(maxH, s.offsetHeight); });
      slides.forEach(s => { s.style.height = maxH + 'px'; });
      slideH = maxH;
      carousel.style.height = maxH + 'px';
      cur = 0;
      track.style.transform = 'translateY(0)';
    }

    function goTo(i) {
      if (slides.length === 0 || slideH === 0) return;
      cur = ((i % slides.length) + slides.length) % slides.length;
      track.style.transform = `translateY(-${cur * slideH}px)`;
      updateControlsState();
    }

    function next() { goTo(cur + 1); }
    function prev() { goTo(cur - 1); }

    function startAuto() {
      stopAuto();
      if (slides.length <= 1) return;
      timer = setInterval(next, 10000); // 10s
    }
    function stopAuto() {
      if (timer) { clearInterval(timer); timer = null; }
      if (resumeTimer) { clearTimeout(resumeTimer); resumeTimer = null; }
    }
    function pauseAndResume() {
      stopAuto();
      if (slides.length > 1) {
        resumeTimer = setTimeout(() => startAuto(), 15000);
      }
    }

    function updateControlsState() {
      const disabled = slides.length <= 1;
      prevBtn.disabled = disabled;
      nextBtn.disabled = disabled;
    }

    // Like delegato
    track.addEventListener('click', (e) => {
      const btnLike = e.target.closest('.like-btn');
      if (!btnLike) return;
      const row = Number(btnLike.dataset.row);
      submitLike(row, btnLike);
      pauseAndResume();
    });

    // Controlli manuali
    prevBtn.addEventListener('click', () => { prev(); pauseAndResume(); });
    nextBtn.addEventListener('click', () => { next(); pauseAndResume(); });

    // Tastiera ‚Üê ‚Üí
    document.addEventListener('keydown', (e) => {
      if (e.key === 'ArrowLeft') { prev(); pauseAndResume(); }
      if (e.key === 'ArrowRight') { next(); pauseAndResume(); }
    });

    // Invio like via form nascosto nell'iframe
    function submitLike(row, btnEl) {
      if (!row || row < 2) return;
      if (btnEl) { btnEl.disabled = true; btnEl.textContent = '...'; }
      lastOp = 'like';

      const form = document.createElement('form');
      form.action = API;
      form.method = 'POST';
      form.target = 'sink';
      form.style.display = 'none';

      const op = document.createElement('input');
      op.name = 'op'; op.value = 'like'; form.appendChild(op);

      const r = document.createElement('input');
      r.name = 'row'; r.value = String(row); form.appendChild(r);

      document.body.appendChild(form);
      form.submit();
      setTimeout(() => form.remove(), 0);
    }

    f.addEventListener('submit', (e) => {
      if (f.website && f.website.value) { e.preventDefault(); setMsg('Bloccato', 'err'); return; }
      if (!f.titolo.value.trim() || !f.suggerimento.value.trim()) { e.preventDefault(); setMsg('Compila i campi obbligatori', 'err'); return; }
      setMsg('Invio in corso‚Ä¶');
      btn.disabled = true;
      lastOp = 'save';
      pauseAndResume();
    });

    sink.addEventListener('load', () => {
      if (lastOp === 'save') {
        setMsg('Inserito correttamente', 'ok');
        f.reset();
        btn.disabled = false;
      }
      loadAll();
      lastOp = null;
    });

    window.addEventListener('resize', () => calibrate());
    document.addEventListener('visibilitychange', () => {
      if (document.hidden) stopAuto(); else startAuto();
    });

    document.addEventListener('DOMContentLoaded', loadAll);
  </script>
</body>
</html>
